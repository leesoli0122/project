 
var diff = 0;

$(function () {
	lf_loadModalDataTableUi();
});

function lf_setModalData(data) {
	const NONE = -1;
	//parent 데이터 세팅
	var progressData = {};
	progressData.difftime = data.difftime;
	var status = data.status;

	//Header
	if(data.equipmarkname) {
		progressData.header = data.equipmarkname + "(" + data.masterip + ")";
	} else if(selectData.equipmarkname) {
		progressData.header = selectData.equipmarkname + "(" + selectData.masterip + ")";
	} else {
		progressData.header = "자산 정보 없음";
	}
	switch(status) {
		case _STATUS['SCAN_INIT'] :			
			$('#scanBtn').text('검사 준비 중');
			$('#scanBtn').removeClass('disabled');
			
			$('#stopBtn').removeClass('disabled');
			if(!data.difftime) data.difftime = 0;
			progressData.header = progressData.header + " 검사 준비";
			progressData.progress = 0;
			progressData.desc = "검사를 준비하고 있습니다.";
			progressData.scanpath = "-";
			progressData.infectcount = 0;
			progressData.scanfilecount = 0;
			progressData.scandircount = 0;
		break;
		
		case _STATUS['SCAN_START'] :			
			$('#scanBtn').text('검사 중');
			$('#scanBtn').removeClass('disabled');
			
			$('#stopBtn').removeClass('disabled');
			
			progressData.header = progressData.header + " 검사 중";
			progressData.progress = data.progress;
			progressData.desc = "검사를 진행하고 있습니다.";
			progressData.scancount = data.scancount;
			progressData.scanpath = data.filename;
			progressData.infectcount = data.infectcount;
			progressData.scanfilecount = data.filecount;
			progressData.scandircount = data.dircount;
		break;		
		case _STATUS['SCAN_IDLE'] : // IDLE			
			$('#scanBtn').text('검사 시작');			
			$('#scanBtn').removeClass('disabled');
			
			$('#stopBtn').addClass('disabled');
			progressData.difftime = -1;
			progressData.header = progressData.header + " 대기";
			progressData.progress = 0;
			progressData.desc = "검사 대기중 입니다.";
			progressData.scanpath = "-";
			progressData.infectcount = 0;
			progressData.scanfilecount = 0;
			progressData.scandircount = 0;			
		break;
		case _STATUS['SCAN_FIN'] : 			
			$('#scanBtn').text('검사 시작');			
			$('#scanBtn').removeClass('disabled');			
			$('#stopBtn').addClass('disabled');
			
			progressData.difftime = -1;
			progressData.header = progressData.header + " 완료";
			progressData.progress = 100;
			if(waitStop) {
				progressData.desc = "검사가 중지되었습니다.";
				waitStop = false;
			} else {
				progressData.desc = "검사를 완료했습니다.";
			}
			progressData.scanpath = "-";
			progressData.infectcount = NONE;
			progressData.scanfilecount = NONE;
			progressData.scandircount = NONE;			
		break;
		case _STATUS['SCAN_FAIL'] : 			
			$('#scanBtn').text('검사 시작');			
			$('#scanBtn').removeClass('disabled');
			
			$('#stopBtn').addClass('disabled');
			
			progressData.difftime = -1;
			progressData.header = data.equipmarkname + "(" + data.masterip + ") 검사 실패";
			progressData.progress = 0;
			progressData.desc = "검사에 실패했습니다.";
			progressData.scanpath = "-";
			progressData.infectcount = 0;
			progressData.scanfilecount = 0;
			progressData.scandircount = 0;
		break;
		default:			
			$('#scanBtn').text('상태 확인 중');			
			$('#scanBtn').addClass('disabled');
			
			$('#stopBtn').addClass('disabled');
			
			progressData.header = data.equipmarkname + "(" + data.masterip + ")";
			progressData.progress = 0;
			progressData.desc = "상태를 확인 할 수 없습니다.";
			progressData.scanpath = "-";
			progressData.infectcount = 0;
			progressData.scanfilecount = 0;
			progressData.scandircount = 0;
		break;
	}
	
	$("#progress_modal_malware > .modal_header > h3").text(progressData.header); // Header
	$('#malwareProgressStatus').val(progressData.desc)
	//console.log(progressData.difftime);
	if(progressData.difftime >= -1) {
		lf_initTime(progressData.difftime);
	}
	if(progressData.scanfilecount != NONE) {
		$('#scanFileCnt').val(progressData.scanfilecount + progressData.scandircount)
	}
	if(progressData.infectcount != NONE) {
		$('#malwareFileCnt').val(progressData.infectcount)
	}
	if(progressData.scanpath) {
		const SIZE = 36;
		var path = progressData.scanpath.length > SIZE? progressData.scanpath.substring(0, SIZE)+'...':progressData.scanpath;
		$('#scanFilePath').val(path);
		$('#scanFilePath').attr('title', progressData.scanpath);
	}
	
}

var timeId;
var timeSec;
function lf_initTime(difftime) {
	//시간이 있는 경우
	//기존 인터벌을 제거한다
	//새로운 인터벌을 걸어준다.
	//시간이 없는경우	
	clearTimeout(timeId);
	if(difftime < 0) {
		$('#malwareProgressTime').val("-");
		return;
	}
	timeSec = difftime;

	var timeFun = function() {
		timeSec++;
		var hour = Math.floor(timeSec/60, 0);
		var sec = timeSec%60;
		if(hour < 10) hour = "0" + hour;
		if(sec < 10) sec = "0" + sec;
		$('#malwareProgressTime').val(hour + ":" + sec);
	};

	timeId = setInterval(timeFun, 1000); 		
}

function lf_loadModalDataTableUi() {
    $('#progressBtn').on('click',function(e){
        var $self = $(this);
        var $thisrel = $self.attr('rel');
        var $target = $('#'+ $thisrel);
        $target.find(".close").on('click',function(){
			//console.log("close click");
        });
        $target.parents('html body').find(".dim").click(function () {
            //console.log("html body dim click");
        });
        
        e.stopPropagation();
    });
}
